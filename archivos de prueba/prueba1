<?php
include 'conexion.php';
session_start();

// Verifica si el usuario está autenticado
if (!isset($_SESSION['user_id'])) {
    echo '<script>alert("No estás autenticado. Por favor, inicia sesión."); window.location.href = "login.php";</script>';
    exit();
}

// Obtener el ID de usuario de la sesión
$user_id = $_SESSION['user_id'];

// Obtener las metas y experiencias actuales del usuario
$consultaMetaExperiencia = "SELECT meta, experiencia FROM información_usuario WHERE id_user = $user_id";
$resultadoMetaExperiencia = mysqli_query($conexion, $consultaMetaExperiencia);

if (!$resultadoMetaExperiencia) {
    die("Error al obtener la información del usuario.");
}


// mysqli_fetch_assoc = Obtiene una fila de resultados como un array asociativo
$filaMetaExperiencia = mysqli_fetch_assoc($resultadoMetaExperiencia);
$metaActual = $filaMetaExperiencia['meta'];
$experienciaActual = $filaMetaExperiencia['experiencia'];

// Verificar si las metas y experiencias actuales son diferentes a las almacenadas en la sesión
if (
    !isset($_SESSION['meta_actual']) || 
    !isset($_SESSION['experiencia_actual']) ||
    $_SESSION['meta_actual'] !== $metaActual || 
    $_SESSION['experiencia_actual'] !== $experienciaActual
) {
    // Actualizar las metas y experiencias actuales en la sesión
    $_SESSION['meta_actual'] = $metaActual;
    $_SESSION['experiencia_actual'] = $experienciaActual;

    // Limpiar la rutina existente en la sesión
    unset($_SESSION['rutina']);
}

// Función para recomendar rutina por día y almacenar en la sesión
function recomendarRutinaPorDia($dia) {
    global $conexion;

    // Obtener el ID de usuario de la sesión
    $user_id = $_SESSION['user_id'];

    // Verificar si ya hay ejercicios recomendados para este día en la sesión
    if (isset($_SESSION['rutina'][$dia])) {
        $rutinaDia = $_SESSION['rutina'][$dia];
    } else {
        // Consulta para obtener todos los ejercicios recomendados según la meta y experiencia del usuario
        $consultaEjercicios = "SELECT * FROM ejercicios WHERE dificultad = '{$_SESSION['experiencia_actual']}' AND objetivo = '{$_SESSION['meta_actual']}' ORDER BY RAND()"; // Ordenar aleatoriamente OJO
        $resultadoEjercicios = mysqli_query($conexion, $consultaEjercicios);

        if (!$resultadoEjercicios) {
            return "Error al obtener ejercicios recomendados.";
        }

        // Verifica si hay algún ejercicio recomendado
        $ejerciciosRecomendados = array();
        while ($filaEjercicio = mysqli_fetch_assoc($resultadoEjercicios)) {
            $filaEjercicio['completado'] = false;  // Añadir la propiedad completado
            $ejerciciosRecomendados[] = $filaEjercicio;
        }

        // Barajar los ejercicios para asignar aleatoriamente
        shuffle($ejerciciosRecomendados);

        // Retorna solo los ejercicios correspondientes al día actual sin repetir
        $rutinaDia = array_slice($ejerciciosRecomendados, 0, min(count($ejerciciosRecomendados), 4));

        // Almacena los ejercicios en la sesión para este día
        $_SESSION['rutina'][$dia] = $rutinaDia;
    }

    // Consulta para obtener los ejercicios marcados como completados en el historial
    $consultaHistorial = "SELECT id_ejercicio FROM historial WHERE id_user = $user_id AND fecha = CURDATE()";
    $resultadoHistorial = mysqli_query($conexion, $consultaHistorial);

    if ($resultadoHistorial) {
        $ejerciciosCompletados = array();
        while ($filaHistorial = mysqli_fetch_assoc($resultadoHistorial)) {
            $ejerciciosCompletados[] = $filaHistorial['id_ejercicio'];
        }

        // Marcar como completados los ejercicios en la rutina
        foreach ($rutinaDia as &$ejercicio) {
            if (in_array($ejercicio['id'], $ejerciciosCompletados)) {
                $ejercicio['completado'] = true;
            }
        }
    }

    return $rutinaDia;
}

// Establecer la zona horaria a Ciudad de México
date_default_timezone_set('America/Mexico_City');

// Obtener el día actual o el seleccionado
$diaSeleccionado = isset($_GET['dia']) ? $_GET['dia'] : date('N'); // 1 para lunes, 2 para martes, ..., 7 para domingo
$detalleEjercicio = recomendarRutinaPorDia($diaSeleccionado);
?>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="rutina.css">
    <title>Rutina</title>
</head>

<body>
<div id="header">
  <ul>
    <li style="--clr:#00ade1">
      <a href="index.html" data-text="&nbsp;Inicio">&nbsp;Inicio&nbsp;</a>
    </li>
    <li style="--clr:#ff6493">
      <a href="perfil2.php" data-text="&nbsp;perfil">&nbsp;Perfil&nbsp;</a>
    </li>
    <li style="--clr:#6E57B4">
      <a href="historial.php" data-text="&nbsp;Historial">&nbsp;Historial&nbsp;</a>
    </li>
  </ul>
  </div>
</body>

<body>

<div class="container">
    <h2>Calendario de Rutina</h2>
    
    <nav>
        <ul>
            <?php
            // Muestra enlaces para cada día de la semana
            for ($i = 1; $i <= 6; $i++) {
                echo "<li><a href='?dia=$i'>" . obtenerNombreDia($i) . "</a></li>";
            }
            ?>
        </ul>
    </nav>

    <?php
    
    
    // Puedes personalizar las rutinas para cada día de la semana
    echo "<p>" . obtenerNombreDia($diaSeleccionado) . "</p>";
    
    if (is_array($detalleEjercicio) && count($detalleEjercicio) > 0) {
        foreach ($detalleEjercicio as $ejercicio) {
            ?>
            <div class="exercise">
                <h3><?php echo $ejercicio['nombre']; ?></h3>
                <p><strong>Descripción:</strong> <?php echo $ejercicio['descripcion']; ?></p>
                <p><strong>Ejecucion:</strong> <br></br><?php echo $ejercicio['ejecucion']; ?></p>
                <p><strong>Músculo Principal:</strong> <?php echo $ejercicio['musculo_principal']; ?></p>
                <p><strong>Músculo Secundario:</strong> <?php echo $ejercicio['musculo_secundario']; ?></p>
                <p><strong>Series:</strong> <?php echo $ejercicio['series']; ?></p>
                <p><strong>Repeticiones:</strong> <?php echo $ejercicio['repeticiones']; ?></p>
                <img src='<?php echo $ejercicio['imagen']; ?>' alt='Imagen del ejercicio'>
                <button class="completado-btn" <?php echo $ejercicio['completado'] ? 'disabled' : ''; ?> onclick="marcarCompletado(this, <?php echo $ejercicio['id']; ?>)">Marcar como completado</button>
            </div>
            <script>
                function marcarCompletado(btn, idEjercicio) {
                btn.innerHTML = "Completado";
                btn.disabled = true;
                btn.style.backgroundColor = "#45a049";
                btn.style.color = "#fff";

                // Obtener el ID de usuario de la sesión
                var userId = <?php echo $_SESSION['user_id']; ?>;

                // Obtener el día actual o el seleccionado
                var diaSeleccionado = <?php echo $diaSeleccionado; ?>;

                // Realizar una solicitud AJAX para insertar el registro en la tabla de historial
                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'guardar_historial.php', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4) {
                        console.log('Respuesta del servidor:', xhr.responseText);
                        if (xhr.status == 200) {
                            console.log('Solicitud completada con éxito.');
                        } else {
                            console.error('Error en la solicitud:', xhr.status, xhr.statusText);
                        }
                    }
                };
                xhr.send('id_user=' + userId + '&id_ejercicio=' + idEjercicio + '&dia_seleccionado=' + diaSeleccionado);
            }
            </script>
            <?php
        }
    } else {
        echo "<p>{$detalleEjercicio}</p>";
    }

    function obtenerNombreDia($numeroDia) {
        // Obtener el nombre del día según el número (1 para lunes, 2 para martes, ..., 7 para domingo)
        $nombresDias = array('Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo');
        return $nombresDias[$numeroDia - 1];
    }
    ?>
</div>

</body>
</html>